@* Views/Kontakt/Index.cshtml (oder Admin/Kontakte.cshtml) *@
@{
    ViewData["Title"] = "Kontakte";
}

<section class="section">
    <div class="container">
        <h1 class="title is-2">Kontakte</h1>

        <!-- Loading State -->
        <div id="loading" class="has-text-centered" style="padding: 3rem;">
            <button class="button is-loading is-large is-white"></button>
            <p class="mt-3">Daten werden geladen...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="notification is-danger is-hidden">
            <button class="delete" onclick="document.getElementById('error').classList.add('is-hidden')"></button>
            <strong>Fehler!</strong> Die Daten konnten nicht geladen werden.
        </div>

        <!-- Content -->
        <div id="content" class="is-hidden">

            <!-- Tabs -->
            <div class="tabs is-boxed is-medium">
                <ul>
                    <li class="is-active" data-tab="immobilienbesitzer">
                        <a onclick="switchTab('immobilienbesitzer')">
                            <span class="icon is-small">
                                <i class="fas fa-building"></i>
                            </span>
                            <span>Immobilienbesitzer</span>
                            <span class="tag is-link ml-2" id="count-besitzer">0</span>
                        </a>
                    </li>
                    <li data-tab="mitarbeiter">
                        <a onclick="switchTab('mitarbeiter')">
                            <span class="icon is-small">
                                <i class="fas fa-users"></i>
                            </span>
                            <span>Mitarbeiter</span>
                            <span class="tag is-primary ml-2" id="count-mitarbeiter">0</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Immobilienbesitzer Tab Content -->
            <div id="tab-immobilienbesitzer" class="tab-content">
                <div class="box">
                    <!-- Suchfeld -->
                    <div class="field">
                        <p class="control has-icons-left">
                            <input class="input" type="text" id="search-besitzer"
                                   placeholder="Suche nach Name, Email oder Telefon..."
                                   onkeyup="filterBesitzer()">
                            <span class="icon is-left">
                                <i class="fas fa-search"></i>
                            </span>
                        </p>
                    </div>

                    <!-- Liste -->
                    <div id="besitzer-liste" class="mt-4">
                        <!-- Wird per JavaScript gefüllt -->
                    </div>
                </div>
            </div>

            <!-- Mitarbeiter Tab Content -->
            <div id="tab-mitarbeiter" class="tab-content is-hidden">
                <div class="box">
                    <!-- Suchfeld -->
                    <div class="field">
                        <p class="control has-icons-left">
                            <input class="input" type="text" id="search-mitarbeiter"
                                   placeholder="Suche nach Name, Email oder Position..."
                                   onkeyup="filterMitarbeiter()">
                            <span class="icon is-left">
                                <i class="fas fa-search"></i>
                            </span>
                        </p>
                    </div>

                    <!-- Liste -->
                    <div id="mitarbeiter-liste" class="mt-4">
                        <!-- Wird per JavaScript gefüllt -->
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- Kontakt Details Modal -->
<div id="kontakt-modal" class="modal">
    <div class="modal-background" onclick="closeKontaktModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modal-title">Kontakt Details</p>
            <button class="delete" onclick="closeKontaktModal()" aria-label="close"></button>
        </header>
        <section class="modal-card-body" id="modal-body">
            <!-- Wird dynamisch gefüllt -->
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closeKontaktModal()">Schließen</button>
        </footer>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = 'https://deine-api.com/api';

        let alleBesitzer = [];
        let alleMitarbeiter = [];

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Daten von API laden
        async function loadKontakte() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');

            try {
                // Immobilienbesitzer laden
                const besitzerResponse = await fetch(`${API_BASE_URL}/kontakte/immobilienbesitzer`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Mitarbeiter laden
                const mitarbeiterResponse = await fetch(`${API_BASE_URL}/kontakte/mitarbeiter`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!besitzerResponse.ok || !mitarbeiterResponse.ok) {
                    throw new Error('API Fehler');
                }

                alleBesitzer = await besitzerResponse.json();
                alleMitarbeiter = await mitarbeiterResponse.json();

                loading.classList.add('is-hidden');
                content.classList.remove('is-hidden');

                // Listen rendern
                renderBesitzer(alleBesitzer);
                renderMitarbeiter(alleMitarbeiter);

                // Counts aktualisieren
                document.getElementById('count-besitzer').textContent = alleBesitzer.length;
                document.getElementById('count-mitarbeiter').textContent = alleMitarbeiter.length;

            } catch (err) {
                console.error('Fehler beim Laden:', err);
                loading.classList.add('is-hidden');
                error.classList.remove('is-hidden');
            }
        }

        // Immobilienbesitzer Liste rendern
        function renderBesitzer(besitzer) {
            const container = document.getElementById('besitzer-liste');

            if (besitzer.length === 0) {
                container.innerHTML = '<p class="has-text-grey has-text-centered">Keine Immobilienbesitzer gefunden.</p>';
                return;
            }

            container.innerHTML = besitzer.map(b => `
                <div class="box is-shadowless has-background-light mb-3">
                    <div class="level is-mobile">
                        <div class="level-left">
                            <div class="level-item">
                                <figure class="image is-48x48">
                                    <span class="icon is-large has-text-link">
                                        <i class="fas fa-user-circle fa-3x"></i>
                                    </span>
                                </figure>
                            </div>
                            <div>
                                <p class="has-text-weight-semibold">${b.name}</p>
                                <p class="is-size-7 has-text-grey">
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-envelope"></i></span>
                                        <span>${b.email}</span>
                                    </span>
                                </p>
                                <p class="is-size-7 has-text-grey">
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-phone"></i></span>
                                        <span>${b.telefon || 'Nicht angegeben'}</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="buttons">
                                <button class="button is-small is-link is-outlined"
                                        onclick="showKontaktDetails(${b.id}, 'besitzer')">
                                    <span class="icon is-small">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                    <span>Details</span>
                                </button>
                                <a href="mailto:${b.email}" class="button is-small is-info is-outlined">
                                    <span class="icon is-small">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mitarbeiter Liste rendern
        function renderMitarbeiter(mitarbeiter) {
            const container = document.getElementById('mitarbeiter-liste');

            if (mitarbeiter.length === 0) {
                container.innerHTML = '<p class="has-text-grey has-text-centered">Keine Mitarbeiter gefunden.</p>';
                return;
            }

            container.innerHTML = mitarbeiter.map(m => `
                <div class="box is-shadowless has-background-light mb-3">
                    <div class="level is-mobile">
                        <div class="level-left">
                            <div class="level-item">
                                <figure class="image is-48x48">
                                    <span class="icon is-large has-text-primary">
                                        <i class="fas fa-user-tie fa-3x"></i>
                                    </span>
                                </figure>
                            </div>
                            <div>
                                <p class="has-text-weight-semibold">${m.name}</p>
                                <p class="is-size-7 has-text-grey mb-1">
                                    <span class="tag is-light">${m.position || 'Mitarbeiter'}</span>
                                </p>
                                <p class="is-size-7 has-text-grey">
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-envelope"></i></span>
                                        <span>${m.email}</span>
                                    </span>
                                </p>
                                <p class="is-size-7 has-text-grey">
                                    <span class="icon-text">
                                        <span class="icon"><i class="fas fa-phone"></i></span>
                                        <span>${m.telefon || 'Nicht angegeben'}</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="buttons">
                                <button class="button is-small is-primary is-outlined"
                                        onclick="showKontaktDetails(${m.id}, 'mitarbeiter')">
                                    <span class="icon is-small">
                                        <i class="fas fa-eye"></i>
                                    </span>
                                    <span>Details</span>
                                </button>
                                <a href="mailto:${m.email}" class="button is-small is-info is-outlined">
                                    <span class="icon is-small">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Tab wechseln
        function switchTab(tabName) {
            // Tab Navigation aktualisieren
            document.querySelectorAll('.tabs li').forEach(li => {
                li.classList.remove('is-active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('is-active');

            // Tab Content wechseln
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('is-hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('is-hidden');
        }

        // Besitzer filtern
        function filterBesitzer() {
            const searchTerm = document.getElementById('search-besitzer').value.toLowerCase();
            const filtered = alleBesitzer.filter(b =>
                b.name.toLowerCase().includes(searchTerm) ||
                b.email.toLowerCase().includes(searchTerm) ||
                (b.telefon && b.telefon.toLowerCase().includes(searchTerm))
            );
            renderBesitzer(filtered);
        }

        // Mitarbeiter filtern
        function filterMitarbeiter() {
            const searchTerm = document.getElementById('search-mitarbeiter').value.toLowerCase();
            const filtered = alleMitarbeiter.filter(m =>
                m.name.toLowerCase().includes(searchTerm) ||
                m.email.toLowerCase().includes(searchTerm) ||
                (m.position && m.position.toLowerCase().includes(searchTerm))
            );
            renderMitarbeiter(filtered);
        }

        // Kontakt Details anzeigen
        async function showKontaktDetails(id, type) {
            const modal = document.getElementById('kontakt-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            try {
                const response = await fetch(`${API_BASE_URL}/kontakte/${type}/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Fehler beim Laden');

                const kontakt = await response.json();

                modalTitle.textContent = kontakt.name;
                modalBody.innerHTML = `
                    <div class="content">
                        <p><strong>Email:</strong> ${kontakt.email}</p>
                        <p><strong>Telefon:</strong> ${kontakt.telefon || 'Nicht angegeben'}</p>
                        ${kontakt.position ? `<p><strong>Position:</strong> ${kontakt.position}</p>` : ''}
                        ${kontakt.adresse ? `<p><strong>Adresse:</strong> ${kontakt.adresse}</p>` : ''}
                        ${kontakt.firma ? `<p><strong>Firma:</strong> ${kontakt.firma}</p>` : ''}
                        ${kontakt.notizen ? `<p><strong>Notizen:</strong><br>${kontakt.notizen}</p>` : ''}
                    </div>
                `;

                modal.classList.add('is-active');

            } catch (err) {
                console.error('Fehler:', err);
                alert('Details konnten nicht geladen werden.');
            }
        }

        // Modal schließen
        function closeKontaktModal() {
            document.getElementById('kontakt-modal').classList.remove('is-active');
        }

        // ESC zum Schließen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeKontaktModal();
        });

        // Beim Laden
        document.addEventListener('DOMContentLoaded', loadKontakte);
    </script>
}
